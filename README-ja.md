# ctlvnet
本ツール群はLinux(Ubuntuを想定しています)で仮想ネットワークを構築するためのものです。

## 初期設定
仮想ノードを作成するためにdockerを設定します。所要時間は10-20分です。  
    $ ./mkimage node

仮想ノードはエンドポイントデバイスやルータとして使うことができます。

## 使い方
構築する仮想ネットワークによって使用するツールが異なります。

### ペアインタフェースの作成
![vnet](https://user-images.githubusercontent.com/56585037/136201934-754d97f7-9c32-408c-ba48-aad1b9ffce1d.png)

仮想ネットワークでは、常にインタフェースの対向にもう一つのインタフェースが存在します。  
ip linkコマンドで仮想インタフェースを作成すると、このコマンドを実行したホストの仮想ネットワーク(名前)空間に2つのペアの仮想インタフェースを作成します。  
この技術を用いて、実ホストの仮想ネットワーク空間にペアの仮想インタフェースを追加します。  

    $ ./ctl2net.sh connect - - - -

試しに以下のコマンドを実行してみてください。

    $ ip address

おそらく veth0, veth1 のペアのインタフェースが生成されていると思います。  
片方のインタフェースから dhclient コマンドでパケットを送って、もう片方のインタフェースで tcpdump コマンドを実行してパケットをキャプチャしてみるとパケットが送信できていることを確認することができます。  
ただし、IPアドレスが振られていません。  
次はIPアドレスを割り振ってみましょう。

    $ sudo ip address add 172.18.100.1/24 dev veth0
    $ sudo ip address add 172.18.100.2/24 dev veth1

IPアドレスが割り振られました。しかし、pingコマンドなどで疎通を確認してみても通信ができません。

    $ ping -I veth0 172.18.100.2

ここで ARP テーブルを見てみましょう。

    $ ip neigh
    ~
    172.18.100.2 dev veth0  FAILED
    ~

と表示されるはずです。  
理由ははっきりとは分かりませんが、リプライが帰って来ないのは退屈です。  
次は仮想ノードを作成して疎通を確認してみましょう。  

その前にインタフェースを削除しましょう。

    $ sudo ip link del veth0

実ホストではipコマンドを用いて手動でインタフェースを削除する必要があります。  
仮想インタフェースは対になっていますので、対向のインタフェースであるveth1も削除されます。

### 仮想ノードの作成とリンクの作成

