# ctlvnet
本ツール群はLinux(Ubuntuを想定しています)で仮想ネットワークを構築するためのものです。

## 初期設定
仮想ノードを作成するためにdockerを設定します。所要時間は10-20分です。  
    $ ./mkimage node

仮想ノードはエンドポイントデバイスやルータとして使うことができます。

## 使い方
構築する仮想ネットワークによって使用するツールが異なります。


### ペアインタフェースの作成
仮想ネットワークでは、常にインタフェースの対向にもう一つのインタフェースが存在します。  
ip linkコマンドで仮想インタフェースを作成すると、このコマンドを実行したホストの仮想ネットワーク(名前)空間に2つのペアの仮想インタフェースを作成します。  
この技術を用いて、実ホスト(Real Host: 略 RH)の仮想ネットワーク空間にペアの仮想インタフェースを追加します。  

    $ ./ctl2net.sh connect - - - -

次の図のようなネットワークが構成されます。

![peer](https://user-images.githubusercontent.com/56585037/136202638-68e1c52b-a938-4915-83b3-d394c5a72c3a.png)

試しに以下のコマンドを実行してみてください。

    $ ip address

おそらく veth0, veth1 のペアのインタフェースが生成されていると思います。  
片方のインタフェースから dhclient コマンドでパケットを送って、もう片方のインタフェースで tcpdump コマンドを実行してパケットをキャプチャしてみるとパケットが送信できていることを確認することができます。  
ただし、IPアドレスが振られていません。  
次はIPアドレスを割り振ってみましょう。

    $ sudo ip address add 172.18.100.1/24 dev veth0
    $ sudo ip address add 172.18.100.2/24 dev veth1

IPアドレスが割り振られました。しかし、pingコマンドなどで疎通を確認してみても通信ができません。

    $ ping -I veth0 172.18.100.2
    ^C

ここで ARP テーブルを見てみましょう。

    $ ip neigh
    ~
    172.18.100.2 dev veth0  FAILED
    ~

と表示されるはずです。  
理由ははっきりとは分かりませんが(ループ防止？)、リプライが帰って来ないのは退屈です。  
次は仮想ノードを作成して疎通を確認してみましょう。  

その前にインタフェースを削除しましょう。

    $ sudo ip link del veth0

実ホストではipコマンドを用いて手動でインタフェースを削除する必要があります。  
仮想インタフェースは対になっていますので、対向のインタフェースであるveth1も削除されます。

### 仮想ノードの作成とリンクの作成
以下のコマンドで仮想ネットワークにノードを作成し、実ホストと接続してください。

    $ ./mkcontainer.sh node node1
    $ ./ctl2net.sh node1 172.18.100.101/24 - 172.18.100.100/24

ここでpingコマンドを実行してみると仮想ノードとパケットをやりとりすることができることがわかります。

    $ ping 172.18.100.101
    $ sudo docker exec -it node1 172.18.100.100

当然、ターミナルを2つ用意し、同時にpingパケットを送ることも可能です。  
以下では実ホストでネットワーク系のコマンドを打つときのプロンプトとして "RH$ ", node1のプロンプトとして "node1$ "を使用しています。

    [Real Host]
    RH$ ping 172.18.100.101

    [node1]
    $ sudo docker exec -it node1 bash
    node1$ ping 172.18.100.100

またノード同士を接続することもできます。

    $ ./mkcontainer.sh node node2
    $ ./ctl2ctl.sh connect node1 172.18.0.1/24 node2 172.18.0.2/24

    [node1]
    node1$ ping 172.18.0.2

    [node2]
    node2$ ping 172.18.0.1

![node](https://user-images.githubusercontent.com/56585037/136220758-b56d61d3-c895-46c0-bd4c-663539c8cecf.png)

どちらもデフォルトでapache2とcurlがインストールされているので、curlでapache2のデフォルトページをダウンロードすることも可能です。  
今回、node1とnode2の2つのホストをデータリンクさせましたが、3つ以上のホストをデータリンクさせることも可能です。  
これを実現するには仮想ブリッジを作成すればよい。Linuxの仮想ブリッジはラーニングスイッチとして作成され、MACアドレス-物理ポートの対応テーブル、いわゆるMACテーブルを参照してパケット(正確にはフレーム)をスイッチングします。  
次に仮想ブリッジを利用したネットワークを構築します。  
その前に node1, node2 を削除します。

    $ ./rmcontainer.sh node1 node2

実ホストRHとnode1はリンクされていましたが、node1削除と同時にnode1のインタフェースが削除されたので、実ホスト側の対向のインタフェースも同時に削除されます。


### L2ネットワーク構築
まずはnode1, node2, node3を作成します。

    $ ./mkcontainer node node1 node2 node3

仮想ブリッジbr0を作成後、node1, node2, node3の3つのノードを接続してみます。  

    $ ./ctl2net.sh setup br0 node1 172.18.0.1/24 node2 172.18.0.2/24 node3 172.18.0.3/24

上記のコマンドは以下のコマンドとほぼ同様の効果を示しています。  

    $ sudo ip link add br0 type bridge
    $ sudo ip link set br0 up
    $ ./ctl2net.sh connect br0 - node1 172.18.0.1/24
    $ ./ctl2net.sh connect br0 - node2 172.18.0.2/24
    $ ./ctl2net.sh connect br0 - node3 172.18.0.3/24

これによってnode1, node2, node3は相互にパケットを送受信できるようになりました。  
試しにnode1からnode2, node3へpingを送ってみます。  

    [node1]
    node1$ ping 172.18.0.2
    ^C
    node1$ ping 172.18.0.3
    ^C

疎通を確認することができるはずです。  
ちなみに仮想ブリッジは仮想インタフェースの一種として作成されます。  
つまり仮想ブリッジインタフェースを作成したホストは仮想ブリッジとなります。  
ブリッジの機能によってはIPパケットなどのL3フレームを送信することがあり
その場合ブリッジ自身にIPアドレスが割り振られていることになります。  
例えばブリッジを制御するためにブリッジへのSSHリモートアクセスを許可している場合、
ブリッジに割り振られたIPアドレスを指定してSSH接続します。  
そのためにブリッジはインタフェースとして作成されるといえるかもしれません。  
以下はスイッチbr0にIPアドレスを割り振って、node1からの疎通を確認しています。

    $ sudo ip address add 172.18.0.100/24 dev br0

    [node1]
    node1$ ping 172.18.0.100
    ^C

疎通を確認できるはずです。
当然、仮想スイッチ(インタフェース)は同一ホストに複数作成することも可能です。

また、スイッチ同士を接続することも可能です。

    $ ./ctl2net.sh setup br1 node4 172.18.0.4/24 node5 172.18.0.5/24
    $ ./ctl2net.sh connect br0 - br1 -

    [node1]
    node1$ ping 172.18.0.5
    ^C

これでブリッジbr0, br1を経由したnode1とnode5のパケット転送を行えたことを確認できました。  
ブリッジbr0のMACアドレステーブルは以下のコマンドで確認できます。

$ bridge fdb show br br0 | grep -vw "permanent"

もし、何も表示されなかったり、表示結果が少ないようならpingなどでパケットを送信してみてください。  
MACアドレステーブルにブリッジに埋め込まれているインタフェースとその対向のMACアドレスの関係が記録されていることが分かります。
このテーブルによってユニキャストへのパケットをセグメント内でブロードキャストせずに送ることができ、帯域を節約することができます。

さて、次はルーティングに触れますが、その前に作成した環境を削除しましょう。

    $ ./rmcontainer node1 node2 node3 node4 node5
    $ ./ctl2net delete br0 br1

以上で作成した環境は削除されたはずです。


### L3ネットワーク構築
